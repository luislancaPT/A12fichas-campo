<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Fichas Campo">
    <meta name="theme-color" content="#1a5276">
    <title>Fichas de Campo | Neuroarquitectura</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        :root { --primary: #1a5276; --success: #27ae60; --danger: #e74c3c; --warning: #f39c12; --bg: #f5f5f5; --card: #fff; --text: #333; --border: #ddd; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; }
        
        /* Header */
        .header { background: linear-gradient(135deg, #1a5276, #2c3e50); color: #fff; padding: 12px 15px; position: sticky; top: 0; z-index: 100; }
        .header-row { display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.1rem; }
        .header-badges { display: flex; gap: 8px; align-items: center; }
        .badge { padding: 4px 10px; border-radius: 15px; font-size: 0.7rem; font-weight: 600; }
        .badge-form { background: #16a085; max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .badge-offline { background: var(--warning); }
        .badge-online { background: var(--success); }
        .badge-sync { background: #3498db; }
        
        /* Sync bar */
        .sync-bar { background: #2c3e50; padding: 8px 15px; display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; }
        .sync-bar.pending { background: #c0392b; }
        .sync-info { opacity: 0.9; }
        .sync-btn { background: #fff; color: #1a5276; border: none; padding: 6px 12px; border-radius: 5px; font-weight: 600; font-size: 0.75rem; }
        
        /* Nav */
        .nav { background: #fff; padding: 8px; overflow-x: auto; white-space: nowrap; border-bottom: 1px solid var(--border); position: sticky; top: 48px; z-index: 90; }
        .nav button { display: inline-block; padding: 6px 10px; margin-right: 4px; border: none; background: #eee; border-radius: 5px; font-size: 0.75rem; }
        .nav button.active { background: var(--primary); color: #fff; }
        
        /* Container */
        .container { max-width: 800px; margin: 0 auto; padding: 12px; padding-bottom: 80px; }
        
        /* Sections */
        .section { display: none; }
        .section.active { display: block; }
        
        /* Cards */
        .card { background: var(--card); border-radius: 10px; padding: 12px; margin-bottom: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.08); }
        .card h2 { font-size: 0.95rem; color: var(--primary); margin-bottom: 10px; padding-bottom: 8px; border-bottom: 2px solid #f0f0f0; }
        .card h3 { font-size: 0.85rem; margin-bottom: 8px; }
        
        /* Forms */
        .form-group { margin-bottom: 10px; }
        label { display: block; font-weight: 500; font-size: 0.8rem; margin-bottom: 4px; color: #555; }
        input, textarea, select { width: 100%; padding: 10px; border: 2px solid var(--border); border-radius: 8px; font-size: 16px; font-family: inherit; background: #fff; -webkit-appearance: none; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--primary); }
        textarea { min-height: 70px; resize: vertical; }
        
        /* Channels */
        .channel { background: #f8f9fa; border-radius: 8px; padding: 10px; margin-bottom: 8px; border-left: 4px solid var(--primary); }
        .channel.visual { border-color: #3498db; }
        .channel.auditivo { border-color: #9b59b6; }
        .channel.olfativo { border-color: #f1c40f; }
        .channel.termico { border-color: #e74c3c; }
        .channel.tactil { border-color: #1abc9c; }
        .channel.espacial { border-color: #34495e; }
        .channel h3 { font-size: 0.85rem; margin-bottom: 5px; }
        
        /* Scales */
        .scale-row { margin-bottom: 12px; }
        .scale-title { font-weight: 600; font-size: 0.85rem; margin-bottom: 4px; }
        .scale-labels { display: flex; justify-content: space-between; font-size: 0.65rem; color: #888; margin-bottom: 4px; }
        .scale-btns { display: flex; flex-wrap: wrap; gap: 4px; }
        .scale-btn { width: 30px; height: 30px; border: 2px solid var(--border); background: #fff; border-radius: 5px; font-weight: 600; font-size: 0.8rem; }
        .scale-btn.selected { background: var(--primary); color: #fff; border-color: var(--primary); }
        
        /* Radio */
        .radio-group { display: flex; flex-direction: column; gap: 6px; }
        .radio-item { display: flex; align-items: center; gap: 8px; padding: 10px; background: #f8f9fa; border-radius: 8px; border: 2px solid transparent; }
        .radio-item.selected { border-color: var(--primary); background: #e8f4f8; }
        .radio-item input { width: 18px; height: 18px; }
        
        /* Quadrant */
        .quadrant-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2px; background: #ddd; border-radius: 8px; overflow: hidden; margin: 8px 0; }
        .quadrant { padding: 12px 8px; text-align: center; }
        .quadrant.selected { box-shadow: inset 0 0 0 3px var(--primary); }
        .q1 { background: #ffebee; }
        .q2 { background: #e8f5e9; }
        .q3 { background: #e3f2fd; }
        .q4 { background: #fffde7; }
        .quadrant strong { display: block; font-size: 0.75rem; }
        .quadrant span { font-size: 0.65rem; color: #666; }
        
        /* Stimulus */
        .stim-row { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
        .stim-row input { flex: 1; }
        .stim-btns { display: flex; gap: 4px; }
        .stim-btn { padding: 6px 10px; border: 2px solid; border-radius: 5px; font-size: 0.7rem; font-weight: 600; background: #fff; }
        .stim-btn.signal { border-color: var(--success); color: var(--success); }
        .stim-btn.noise { border-color: var(--danger); color: var(--danger); }
        .stim-btn.selected { color: #fff; }
        .stim-btn.signal.selected { background: var(--success); }
        .stim-btn.noise.selected { background: var(--danger); }
        
        /* Intervention */
        .intervention { background: #f8f9fa; border: 2px solid #ddd; border-radius: 8px; padding: 10px; margin-bottom: 10px; }
        .intervention h3 { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .int-num { width: 22px; height: 22px; background: var(--primary); color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; }
        .chain-input { margin-bottom: 6px; }
        .chain-input input { padding: 8px; font-size: 14px; }
        
        /* Buttons */
        .btn { display: inline-block; padding: 10px 16px; border: none; border-radius: 8px; font-size: 0.9rem; font-weight: 600; cursor: pointer; text-align: center; }
        .btn-primary { background: var(--primary); color: #fff; }
        .btn-secondary { background: #eee; color: #333; }
        .btn-success { background: var(--success); color: #fff; }
        .btn-danger { background: var(--danger); color: #fff; }
        .btn-block { display: block; width: 100%; }
        .btn-sm { padding: 8px 12px; font-size: 0.8rem; }
        
        .nav-btns { display: flex; gap: 8px; justify-content: space-between; margin-top: 15px; padding-top: 12px; border-top: 2px solid #eee; }
        
        /* Forms list */
        .form-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 8px; border: 2px solid transparent; }
        .form-item.active { border-color: var(--primary); background: #e8f4f8; }
        .form-item.pending { border-left: 4px solid var(--warning); }
        .form-item.synced { border-left: 4px solid var(--success); }
        .form-item-icon { width: 36px; height: 36px; background: var(--primary); color: #fff; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .form-item-info { flex: 1; }
        .form-item-title { font-weight: 600; font-size: 0.85rem; }
        .form-item-meta { font-size: 0.7rem; color: #888; }
        .form-item-actions { display: flex; gap: 5px; }
        .form-item-btn { width: 28px; height: 28px; border: none; border-radius: 5px; color: #fff; font-size: 0.8rem; }
        .form-item-btn.delete { background: var(--danger); }
        .form-item-btn.export { background: #3498db; }
        
        /* Export */
        .export-box { background: #e8f4f8; border: 2px solid var(--primary); border-radius: 8px; padding: 12px; margin-bottom: 12px; }
        .export-box h3 { color: var(--primary); margin-bottom: 8px; font-size: 0.9rem; }
        .export-box p { font-size: 0.8rem; color: #555; margin-bottom: 8px; }
        .export-btns { display: flex; flex-wrap: wrap; gap: 6px; }
        .export-btn { padding: 8px 12px; background: #fff; border: 2px solid var(--primary); border-radius: 6px; color: var(--primary); font-weight: 600; font-size: 0.8rem; }
        
        .copy-area { margin-top: 10px; display: none; }
        .copy-area.show { display: block; }
        .copy-area textarea { font-family: monospace; font-size: 0.7rem; height: 100px; }
        
        /* Help */
        .help-tip { display: inline-block; width: 16px; height: 16px; background: #3498db; color: #fff; border-radius: 50%; text-align: center; font-size: 0.6rem; line-height: 16px; margin-left: 4px; }
        .help-box { background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; padding: 8px; margin-top: 5px; font-size: 0.75rem; display: none; }
        .help-box.show { display: block; }
        
        /* Toast */
        .toast { position: fixed; bottom: 70px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 10px 20px; border-radius: 8px; z-index: 1000; display: none; font-size: 0.85rem; }
        .toast.show { display: block; }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        
        /* Modal */
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 200; display: none; align-items: center; justify-content: center; padding: 15px; }
        .modal.show { display: flex; }
        .modal-content { background: #fff; border-radius: 12px; width: 100%; max-width: 400px; max-height: 80vh; overflow: hidden; }
        .modal-header { padding: 12px 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-size: 1rem; }
        .modal-close { background: none; border: none; font-size: 1.5rem; color: #888; }
        .modal-body { padding: 15px; max-height: 60vh; overflow-y: auto; }
        .modal-footer { padding: 10px 15px; border-top: 1px solid #eee; display: flex; gap: 8px; justify-content: flex-end; }
        
        /* Status bar */
        .status-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #2c3e50; color: #fff; padding: 8px 15px; display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; z-index: 100; }
        .status-bar.has-pending { background: #c0392b; }
    </style>
</head>
<body>

<div class="header">
    <div class="header-row">
        <h1>üìã Fichas de Campo</h1>
        <div class="header-badges">
            <span class="badge badge-form" id="currentFormBadge">Nova</span>
            <span class="badge" id="networkBadge">‚è≥</span>
        </div>
    </div>
</div>

<div class="sync-bar" id="syncBar">
    <span class="sync-info" id="syncInfo">üíæ Tudo guardado localmente</span>
    <button class="sync-btn" id="syncBtn" onclick="showSyncModal()">üì§ Exportar</button>
</div>

<div class="nav" id="nav"></div>

<div class="container">
    <!-- Sections will be generated by JS -->
    <div id="sectionsContainer"></div>
</div>

<!-- Sync Modal -->
<div class="modal" id="syncModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üì§ Exportar / Sincronizar</h2>
            <button class="modal-close" onclick="closeModal('syncModal')">√ó</button>
        </div>
        <div class="modal-body">
            <div class="export-box">
                <h3>üìã Copiar para Google Sheets</h3>
                <p>Copia todos os dados em formato tabela.</p>
                <button class="export-btn" onclick="copyAllForSheets()">üìã Copiar Tudo</button>
                <div class="copy-area" id="sheetsArea">
                    <textarea id="sheetsText" readonly onclick="this.select()"></textarea>
                    <p style="font-size: 0.7rem; color: #666; margin-top: 5px;">üëÜ Toque ‚Üí Selecionar tudo ‚Üí Copiar ‚Üí Cole no Google Sheets</p>
                </div>
            </div>
            
            <div class="export-box">
                <h3>üíæ Exportar Ficheiros</h3>
                <p>Guarda ficheiros que pode colocar no Google Drive.</p>
                <div class="export-btns">
                    <button class="export-btn" onclick="exportAllJSON()">üìÑ JSON (backup)</button>
                    <button class="export-btn" onclick="exportAllCSV()">üìä CSV (Excel)</button>
                </div>
            </div>
            
            <div class="export-box">
                <h3>üì• Importar Backup</h3>
                <p>Restaura dados de um ficheiro JSON anterior.</p>
                <input type="file" id="importFile" accept=".json" onchange="importBackup(this)" style="font-size: 14px;">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('syncModal')">Fechar</button>
        </div>
    </div>
</div>

<!-- Forms Modal -->
<div class="modal" id="formsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üìÅ Gest√£o de Fichas</h2>
            <button class="modal-close" onclick="closeModal('formsModal')">√ó</button>
        </div>
        <div class="modal-body">
            <div id="formsList"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('formsModal')">Fechar</button>
            <button class="btn btn-primary" onclick="newForm(); closeModal('formsModal');">‚ûï Nova</button>
        </div>
    </div>
</div>

<!-- Help Modal -->
<div class="modal" id="helpModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="helpTitle">Ajuda</h2>
            <button class="modal-close" onclick="closeModal('helpModal')">√ó</button>
        </div>
        <div class="modal-body">
            <div id="helpContent"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="closeModal('helpModal')">OK</button>
        </div>
    </div>
</div>

<div class="status-bar" id="statusBar">
    <span id="statusText">üíæ Pronto</span>
    <span id="pendingCount"></span>
</div>

<div class="toast" id="toast"></div>

<script>
// ===== APP STATE =====
var APP = {
    currentFormId: null,
    currentSection: 0,
    forms: {},
    isOnline: navigator.onLine
};

// ===== SECTIONS CONFIG =====
var SECTIONS = [
    { id: 0, title: 'In√≠cio', icon: 'üìù', short: 'In√≠cio' },
    { id: 1, title: 'Espacio', icon: 'üè¢', short: '1.Esp' },
    { id: 2, title: 'Ambiental', icon: 'üåê', short: '2.Amb' },
    { id: 3, title: 'Sensorial', icon: '‚ö°', short: '3.Sen' },
    { id: 4, title: 'Atenci√≥n', icon: 'üß†', short: '4.Ate' },
    { id: 5, title: 'Percepci√≥n', icon: 'üëÅÔ∏è', short: '5.Per' },
    { id: 6, title: 'Reconocimiento', icon: 'üí°', short: '6.Rec' },
    { id: 7, title: 'Emoci√≥n', icon: '‚ù§Ô∏è', short: '7.Emo' },
    { id: 8, title: 'Evidencia', icon: 'üë§', short: '8.Evi' },
    { id: 9, title: 'Intervenci√≥n', icon: 'üîß', short: '9.Int' },
    { id: 10, title: 'Exportar', icon: 'üíæ', short: 'üíæ' }
];

var SCALES = [
    { id: 'atSelectiva', title: 'üéØ ATENCI√ìN SELECTIVA', min: 0, labels: ['0=Sin distractores', '10=Distractores constantes'] },
    { id: 'atSostenida', title: '‚è±Ô∏è ATENCI√ìN SOSTENIDA', min: 0, labels: ['0=Sin fatiga', '10=Fatiga r√°pida'] },
    { id: 'atOrientacion', title: 'üß≠ ORIENTACI√ìN', min: 0, labels: ['0=No se entiende', '10=Gu√≠a clara'] },
    { id: 'atEjecutivo', title: 'üéõÔ∏è CONTROL EJECUTIVO', min: 0, labels: ['0=Sin conflicto', '10=Exige inhibir'] },
    { id: 'atDividida', title: 'üîÄ ATENCI√ìN DIVIDIDA', min: 0, labels: ['0=Multitarea OK', '10=Se deteriora'] },
    { id: 'percSeguro', title: 'üîê INSEGURO ‚Üî SEGURO', min: 1, labels: ['1=Inseguro', '10=Seguro'] },
    { id: 'percOrdenado', title: 'üå™Ô∏è CA√ìTICO ‚Üî ORDENADO', min: 1, labels: ['1=Ca√≥tico', '10=Ordenado'] },
    { id: 'percAcogedor', title: 'üò† HOSTIL ‚Üî ACOGEDOR', min: 1, labels: ['1=Hostil', '10=Acogedor'] },
    { id: 'percClaro', title: '‚ùì CONFUSO ‚Üî CLARO', min: 1, labels: ['1=Confuso', '10=Claro'] },
    { id: 'emoValencia', title: 'üíö VALENCIA', min: 0, labels: ['0=Desagradable', '10=Agradable'] },
    { id: 'emoActivacion', title: '‚ö° ACTIVACI√ìN', min: 0, labels: ['0=Calma', '10=Nerviosismo'] }
];

var HELP = {
    espacio: { title: 'üè¢ Espacio', text: '<b>Incluya:</b> Tipo de espacio + Nombre del edificio + Zona<br><em>Ej: "Sala de espera - Urgencias Hospital General"</em>' },
    actividad: { title: 'üéØ Actividad', text: '<b>Elija UNA actividad objetivo.</b> Cada est√≠mulo se evaluar√° en funci√≥n de esta actividad.<br>‚Ä¢ Wayfinding: Orientarse<br>‚Ä¢ Esperar: Sin estr√©s<br>‚Ä¢ Concentrarse: Trabajar/estudiar<br>‚Ä¢ Recuperarse: Descansar<br>‚Ä¢ Socializar: Interactuar' },
    senalruido: { title: '‚ö° Se√±al vs Ruido', text: '<b>SE√ëAL (‚úì):</b> Ayuda la actividad<br><b>RUIDO (‚úó):</b> Dificulta la actividad<br><em>Ej: Para "esperar sin estr√©s", TV alta = RUIDO</em>' },
    affordances: { title: 'ü™ë Affordances', text: 'Lo que el espacio "invita" a hacer:<br>‚Ä¢ Banco ‚Üí sentarse<br>‚Ä¢ Pasillo ‚Üí avanzar<br>‚Ä¢ Luz c√°lida ‚Üí relajarse' },
    intervencion: { title: 'üîß Microintervenci√≥n', text: '<b>Requisitos:</b><br>‚Ä¢ M√°ximo 2 cambios<br>‚Ä¢ Realistas y econ√≥micos<br>‚Ä¢ Justificar efecto en cadena<br><em>Ej: A√±adir plantas, reducir volumen TV</em>' }
};

// ===== INITIALIZATION =====
function init() {
    loadForms();
    buildUI();
    setupNetwork();
    
    var lastId = localStorage.getItem('lastFormId');
    if (lastId && APP.forms[lastId]) {
        loadForm(lastId);
    } else if (Object.keys(APP.forms).length > 0) {
        loadForm(Object.keys(APP.forms)[0]);
    } else {
        newForm();
    }
    
    // Register service worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').then(function() {
            console.log('SW registered');
        }).catch(function(e) {
            console.log('SW failed', e);
        });
    }
}

function buildUI() {
    // Build navigation
    var nav = document.getElementById('nav');
    nav.innerHTML = SECTIONS.map(function(s) {
        return '<button onclick="goTo(' + s.id + ')">' + s.short + '</button>';
    }).join('');
    
    // Build sections
    var container = document.getElementById('sectionsContainer');
    container.innerHTML = SECTIONS.map(function(s) {
        return '<div class="section" id="sec' + s.id + '">' + buildSection(s.id) + '</div>';
    }).join('');
    
    // Init scale buttons
    SCALES.forEach(function(scale) {
        createScaleButtons(scale.id, scale.min);
    });
}

function buildSection(id) {
    switch(id) {
        case 0: return buildSectionStart();
        case 1: return buildSectionEspacio();
        case 2: return buildSectionAmbiental();
        case 3: return buildSectionSensorial();
        case 4: return buildSectionAtencion();
        case 5: return buildSectionPercepcion();
        case 6: return buildSectionReconocimiento();
        case 7: return buildSectionEmocion();
        case 8: return buildSectionEvidencia();
        case 9: return buildSectionIntervencion();
        case 10: return buildSectionExport();
        default: return '';
    }
}

function buildSectionStart() {
    return '<div class="card"><h2>üìù Identificaci√≥n</h2>' +
        '<div class="form-group"><label>Nombre *</label><input type="text" id="nombre" onchange="save()"></div>' +
        '<div class="form-group"><label>Fecha *</label><input type="date" id="fecha" onchange="save()"></div>' +
        '<div class="form-group"><label>Hora</label><input type="time" id="hora" onchange="save()"></div>' +
        '</div>' +
        '<div class="card"><h2>üìÅ Gest√£o de Fichas</h2>' +
        '<p style="font-size:0.8rem;color:#666;margin-bottom:10px;">Crie m√∫ltiplas fichas para diferentes espa√ßos.</p>' +
        '<button class="btn btn-primary btn-block" onclick="newForm()" style="margin-bottom:8px;">‚ûï Nova Ficha</button>' +
        '<button class="btn btn-secondary btn-block" onclick="showModal(\'formsModal\'); renderFormsList();">üìÅ Ver Fichas (' + Object.keys(APP.forms).length + ')</button>' +
        '</div>' +
        navButtons(null, 1);
}

function buildSectionEspacio() {
    return '<div class="card"><h2>üè¢ Ficha 1: Espacio</h2>' +
        '<div class="form-group"><label>Nombre del espacio * <span class="help-tip" onclick="showHelp(\'espacio\')">?</span></label><input type="text" id="nombreEspacio" placeholder="Ej: Sala de espera Hospital X" onchange="save()"></div>' +
        '<div class="form-group"><label>Ubicaci√≥n</label><input type="text" id="ubicacion" onchange="save()"></div>' +
        '<div class="form-group"><label>Meteorolog√≠a</label><select id="meteo" onchange="save()"><option value="">Seleccione...</option><option value="soleado">‚òÄÔ∏è Soleado</option><option value="nublado">‚òÅÔ∏è Nublado</option><option value="lluvioso">üåßÔ∏è Lluvioso</option><option value="interior">üè† Interior</option></select></div>' +
        '</div>' +
        '<div class="card"><h2>üéØ Actividad Objetivo <span class="help-tip" onclick="showHelp(\'actividad\')">?</span></h2>' +
        '<div class="radio-group">' +
        ['wayfinding|üß≠ Orientarse','esperar|‚è≥ Esperar sin estr√©s','concentrarse|üìö Concentrarse','recuperarse|üßò Recuperarse','socializar|üë• Socializar','otra|üìù Otra'].map(function(o) {
            var p = o.split('|');
            return '<label class="radio-item" onclick="selectRadio(this,\'actividad\',\'' + p[0] + '\')"><input type="radio" name="actividad" value="' + p[0] + '"><span>' + p[1] + '</span></label>';
        }).join('') +
        '</div>' +
        '<input type="text" id="actividadOtra" placeholder="Si \'Otra\'..." style="margin-top:8px;" onchange="save()">' +
        '</div>' +
        '<div class="card"><h2>üìè Mediciones</h2>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;">' +
        '<div class="form-group"><label>üí° Lux</label><input type="number" id="lux" onchange="save()"></div>' +
        '<div class="form-group"><label>üîä dB</label><input type="number" id="db" onchange="save()"></div>' +
        '<div class="form-group"><label>üå°Ô∏è ¬∞C</label><input type="number" id="temp" onchange="save()"></div>' +
        '</div>' +
        '<div class="form-group"><label>Estimaci√≥n cualitativa</label><textarea id="estimacionCualitativa" onchange="save()"></textarea></div>' +
        '<div class="form-group"><label>Descripci√≥n del espacio</label><textarea id="descripcionEspacio" onchange="save()"></textarea></div>' +
        '</div>' +
        navButtons(0, 2);
}

function buildSectionAmbiental() {
    var channels = [
        { id: 'visual', icon: 'üëÅÔ∏è', title: 'VISUAL', ex: 'Luz, colores, carteles...' },
        { id: 'auditivo', icon: 'üëÇ', title: 'AUDITIVO', ex: 'M√∫sica, ruido...' },
        { id: 'olfativo', icon: 'üëÉ', title: 'OLFATIVO', ex: 'Olores...' },
        { id: 'termico', icon: 'üå°Ô∏è', title: 'T√âRMICO', ex: 'Temperatura...' },
        { id: 'tactil', icon: '‚úã', title: 'T√ÅCTIL', ex: 'Texturas...' },
        { id: 'espacial', icon: 'üìê', title: 'ESPACIAL', ex: 'Distribuci√≥n...' }
    ];
    return '<div class="card"><h2>üåê Ficha 2: Estimulaci√≥n Ambiental</h2>' +
        channels.map(function(c) {
            return '<div class="channel ' + c.id + '"><h3>' + c.icon + ' ' + c.title + '</h3><textarea id="est' + c.id.charAt(0).toUpperCase() + c.id.slice(1) + '" placeholder="' + c.ex + '" onchange="save()"></textarea></div>';
        }).join('') +
        '</div>' + navButtons(1, 3);
}

function buildSectionSensorial() {
    var stims = '';
    for (var i = 1; i <= 5; i++) {
        stims += '<div class="stim-row"><input type="text" id="stim' + i + '" placeholder="Est√≠mulo ' + i + '" onchange="save()"><div class="stim-btns"><button class="stim-btn signal" id="stim' + i + 'S" onclick="toggleSN(\'stim' + i + '\',\'S\')">‚úì</button><button class="stim-btn noise" id="stim' + i + 'R" onclick="toggleSN(\'stim' + i + '\',\'R\')">‚úó</button></div></div>';
    }
    return '<div class="card"><h2>‚ö° Ficha 3: Se√±al vs Ruido <span class="help-tip" onclick="showHelp(\'senalruido\')">?</span></h2>' + stims + '</div>' +
        '<div class="card"><h2>‚ö†Ô∏è Conflictos Multisensoriales</h2><textarea id="conflictos" placeholder="¬øIncongruencia entre canales?" onchange="save()"></textarea></div>' +
        navButtons(2, 4);
}

function buildSectionAtencion() {
    var scales = SCALES.filter(function(s) { return s.id.startsWith('at'); });
    return '<div class="card"><h2>üß† Ficha 4: Atenci√≥n</h2>' +
        scales.map(function(s) {
            return '<div class="scale-row"><div class="scale-title">' + s.title + '</div><div class="scale-labels"><span>' + s.labels[0] + '</span><span>' + s.labels[1] + '</span></div><div class="scale-btns" id="scale_' + s.id + '"></div><textarea id="' + s.id + 'Just" placeholder="Justificaci√≥n..." style="margin-top:6px;" onchange="save()"></textarea></div>';
        }).join('') +
        '</div>' + navButtons(3, 5);
}

function buildSectionPercepcion() {
    var scales = SCALES.filter(function(s) { return s.id.startsWith('perc'); });
    return '<div class="card"><h2>üëÅÔ∏è Ficha 5: Percepci√≥n</h2>' +
        scales.map(function(s) {
            return '<div class="scale-row"><div class="scale-title">' + s.title + '</div><div class="scale-btns" id="scale_' + s.id + '"></div><textarea id="' + s.id + 'Just" placeholder="Justificaci√≥n..." style="margin-top:6px;" onchange="save()"></textarea></div>';
        }).join('') +
        '</div>' + navButtons(4, 6);
}

function buildSectionReconocimiento() {
    return '<div class="card"><h2>üí° Ficha 6: Reconocimiento</h2>' +
        '<div class="form-group"><label>üèõÔ∏è Funci√≥n del lugar</label><textarea id="recFuncion" placeholder="¬øQu√© entiende el usuario?" onchange="save()"></textarea></div>' +
        '<div class="form-group"><label>üìú Reglas impl√≠citas</label><textarea id="recReglas" placeholder="¬øQu√© comportamientos se esperan?" onchange="save()"></textarea></div>' +
        '<div class="form-group"><label>ü™ë Affordances <span class="help-tip" onclick="showHelp(\'affordances\')">?</span></label><textarea id="recAffordances" placeholder="¬øQu√© invita a hacer?" onchange="save()"></textarea></div>' +
        '<div class="form-group"><label>üìç Puntos de referencia</label><textarea id="recPuntos" placeholder="¬øQu√© organiza la atenci√≥n?" onchange="save()"></textarea></div>' +
        '</div>' + navButtons(5, 7);
}

function buildSectionEmocion() {
    var scales = SCALES.filter(function(s) { return s.id.startsWith('emo'); });
    return '<div class="card"><h2>‚ù§Ô∏è Ficha 7: Emoci√≥n</h2>' +
        scales.map(function(s) {
            return '<div class="scale-row"><div class="scale-title">' + s.title + '</div><div class="scale-labels"><span>' + s.labels[0] + '</span><span>' + s.labels[1] + '</span></div><div class="scale-btns" id="scale_' + s.id + '"></div><textarea id="' + s.id + 'Just" placeholder="Justificaci√≥n..." style="margin-top:6px;" onchange="save()"></textarea></div>';
        }).join('') +
        '<div style="margin-top:12px;"><strong style="font-size:0.85rem;">üìä Cuadrante:</strong>' +
        '<div class="quadrant-grid"><div class="quadrant q1" id="qAltaNeg" onclick="selectQuad(\'alta-neg\')"><strong>Alta+Neg</strong><span>Ansiedad</span></div><div class="quadrant q2" id="qAltaPos" onclick="selectQuad(\'alta-pos\')"><strong>Alta+Pos</strong><span>Entusiasmo</span></div><div class="quadrant q3" id="qBajaNeg" onclick="selectQuad(\'baja-neg\')"><strong>Baja+Neg</strong><span>Apat√≠a</span></div><div class="quadrant q4" id="qBajaPos" onclick="selectQuad(\'baja-pos\')"><strong>Baja+Pos</strong><span>Calma</span></div></div></div>' +
        '</div>' + navButtons(6, 8);
}

function buildSectionEvidencia() {
    var evids = '';
    for (var i = 1; i <= 2; i++) {
        evids += '<div class="form-group"><label>Emoci√≥n ' + i + '</label><input type="text" id="evid' + i + 'Emo" placeholder="Emoci√≥n" onchange="save()"><input type="text" id="evid' + i + 'Comp" placeholder="Comportamientos" style="margin-top:5px;" onchange="save()"><input type="text" id="evid' + i + 'Disp" placeholder="Disparadores" style="margin-top:5px;" onchange="save()"></div>';
    }
    return '<div class="card"><h2>üë§ Ficha 8: Evidencia</h2>' + evids +
        '<div class="form-group"><label>Observaciones</label><textarea id="evidenceNotes" onchange="save()"></textarea></div>' +
        '</div>' + navButtons(7, 9);
}

function buildSectionIntervencion() {
    var ints = '';
    for (var i = 1; i <= 2; i++) {
        var chain = ['EstAmb|Est. ambiental','EstSens|Est. sensorial','Atencion|Atenci√≥n','Percepcion|Percepci√≥n','Reconocimiento|Reconocimiento','Emocion|Emoci√≥n'].map(function(c) {
            var p = c.split('|');
            return '<div class="chain-input"><input type="text" id="int' + i + p[0] + '" placeholder="‚Üí ' + p[1] + '" onchange="save()"></div>';
        }).join('');
        ints += '<div class="intervention"><h3><span class="int-num">' + i + '</span> Microintervenci√≥n ' + i + '</h3><div class="form-group"><label>Cambio propuesto</label><textarea id="int' + i + 'Cambio" onchange="save()"></textarea></div><p style="font-size:0.8rem;font-weight:600;margin-bottom:6px;">Efecto en cadena:</p>' + chain + '</div>';
    }
    return '<div class="card"><h2>üîß Ficha 9: Microintervenci√≥n <span class="help-tip" onclick="showHelp(\'intervencion\')">?</span></h2>' + ints + '</div>' + navButtons(8, 10);
}

function buildSectionExport() {
    return '<div class="card"><h2>‚úÖ Ficha Completada!</h2><div class="form-group"><label>üìù Notas finais</label><textarea id="notasFinales" onchange="save()"></textarea></div></div>' +
        '<div class="export-box"><h3>üì§ Exportar Esta Ficha</h3><div class="export-btns"><button class="export-btn" onclick="copyCurrentForSheets()">üìã Copiar</button><button class="export-btn" onclick="exportCurrentJSON()">üìÑ JSON</button></div><div class="copy-area" id="currentCopyArea"><textarea id="currentCopyText" readonly onclick="this.select()"></textarea></div></div>' +
        '<div class="export-box"><h3>üìÅ Gest√£o</h3><div class="export-btns"><button class="export-btn" onclick="newForm()">‚ûï Nova</button><button class="export-btn" onclick="duplicateForm()">üìã Duplicar</button><button class="export-btn" onclick="showModal(\'formsModal\'); renderFormsList();">üìÅ Ver Todas</button></div></div>' +
        navButtons(9, null);
}

function navButtons(prev, next) {
    var html = '<div class="nav-btns">';
    if (prev !== null) html += '<button class="btn btn-secondary" onclick="goTo(' + prev + ')">‚Üê Anterior</button>';
    else html += '<div></div>';
    if (next !== null) html += '<button class="btn btn-primary" onclick="goTo(' + next + ')">Siguiente ‚Üí</button>';
    else html += '<button class="btn btn-success" onclick="save(); toast(\'Guardado!\');">üíæ Guardar</button>';
    return html + '</div>';
}

function createScaleButtons(scaleId, minVal) {
    var container = document.getElementById('scale_' + scaleId);
    if (!container) return;
    container.innerHTML = '';
    for (var i = minVal; i <= 10; i++) {
        var btn = document.createElement('button');
        btn.className = 'scale-btn';
        btn.textContent = i;
        btn.setAttribute('data-val', i);
        btn.onclick = (function(sid, val) {
            return function() { selectScale(sid, val); };
        })(scaleId, i);
        container.appendChild(btn);
    }
}

// ===== NAVIGATION =====
function goTo(n) {
    save();
    document.querySelectorAll('.section').forEach(function(s) { s.classList.remove('active'); });
    document.querySelectorAll('.nav button').forEach(function(b) { b.classList.remove('active'); });
    document.getElementById('sec' + n).classList.add('active');
    document.querySelectorAll('.nav button')[n].classList.add('active');
    APP.currentSection = n;
    window.scrollTo(0, 0);
}

// ===== FORMS MANAGEMENT =====
function loadForms() {
    try {
        APP.forms = JSON.parse(localStorage.getItem('neuroForms') || '{}');
    } catch(e) {
        APP.forms = {};
    }
}

function saveForms() {
    localStorage.setItem('neuroForms', JSON.stringify(APP.forms));
    updateSyncStatus();
}

function newForm() {
    var id = 'f' + Date.now();
    APP.forms[id] = {
        id: id,
        created: new Date().toISOString(),
        modified: new Date().toISOString(),
        synced: false,
        data: { fecha: new Date().toISOString().split('T')[0] },
        scales: {},
        quadrant: null,
        stimuli: {}
    };
    saveForms();
    loadForm(id);
    toast('Nova ficha criada!');
}

function loadForm(id) {
    if (!APP.forms[id]) return;
    
    APP.currentFormId = id;
    localStorage.setItem('lastFormId', id);
    var form = APP.forms[id];
    
    // Clear all
    document.querySelectorAll('input[type="text"], input[type="date"], input[type="time"], input[type="number"], textarea, select').forEach(function(el) { el.value = ''; });
    document.querySelectorAll('input[type="radio"]').forEach(function(el) { el.checked = false; el.parentElement.classList.remove('selected'); });
    document.querySelectorAll('.scale-btn').forEach(function(el) { el.classList.remove('selected'); });
    document.querySelectorAll('.quadrant').forEach(function(el) { el.classList.remove('selected'); });
    document.querySelectorAll('.stim-btn').forEach(function(el) { el.classList.remove('selected'); });
    
    // Load data
    if (form.data) {
        Object.keys(form.data).forEach(function(k) {
            var el = document.getElementById(k);
            if (el) el.value = form.data[k];
        });
        if (form.data.actividad) {
            var r = document.querySelector('input[name="actividad"][value="' + form.data.actividad + '"]');
            if (r) { r.checked = true; r.parentElement.classList.add('selected'); }
        }
    }
    
    // Load scales
    if (form.scales) {
        Object.keys(form.scales).forEach(function(s) {
            var container = document.getElementById('scale_' + s);
            if (container) {
                var btn = container.querySelector('[data-val="' + form.scales[s] + '"]');
                if (btn) btn.classList.add('selected');
            }
        });
    }
    
    // Load quadrant
    if (form.quadrant) {
        var qMap = { 'alta-neg': 'qAltaNeg', 'alta-pos': 'qAltaPos', 'baja-neg': 'qBajaNeg', 'baja-pos': 'qBajaPos' };
        var qEl = document.getElementById(qMap[form.quadrant]);
        if (qEl) qEl.classList.add('selected');
    }
    
    // Load stimuli
    if (form.stimuli) {
        Object.keys(form.stimuli).forEach(function(k) {
            var type = form.stimuli[k];
            var btn = document.getElementById(k + type);
            if (btn) btn.classList.add('selected');
        });
    }
    
    updateBadge();
    updateSyncStatus();
}

function save() {
    if (!APP.currentFormId) return;
    
    var form = APP.forms[APP.currentFormId];
    if (!form) return;
    
    var data = {};
    var fields = ['nombre','fecha','hora','nombreEspacio','ubicacion','meteo','actividadOtra','lux','db','temp','estimacionCualitativa','descripcionEspacio','estVisual','estAuditivo','estOlfativo','estTermico','estTactil','estEspacial','stim1','stim2','stim3','stim4','stim5','conflictos','atSelectivaJust','atSostenidaJust','atOrientacionJust','atEjecutivoJust','atDivididaJust','percSeguroJust','percOrdenadoJust','percAcogedorJust','percClaroJust','recFuncion','recReglas','recAffordances','recPuntos','emoValenciaJust','emoActivacionJust','evid1Emo','evid1Comp','evid1Disp','evid2Emo','evid2Comp','evid2Disp','evidenceNotes','int1Cambio','int1EstAmb','int1EstSens','int1Atencion','int1Percepcion','int1Reconocimiento','int1Emocion','int2Cambio','int2EstAmb','int2EstSens','int2Atencion','int2Percepcion','int2Reconocimiento','int2Emocion','notasFinales'];
    
    fields.forEach(function(f) {
        var el = document.getElementById(f);
        if (el) data[f] = el.value;
    });
    
    var actRadio = document.querySelector('input[name="actividad"]:checked');
    if (actRadio) data.actividad = actRadio.value;
    
    form.data = data;
    form.modified = new Date().toISOString();
    form.synced = false;
    
    saveForms();
    updateBadge();
    document.getElementById('statusText').textContent = 'üíæ Guardado';
}

function deleteForm(id) {
    if (!confirm('Eliminar esta ficha?')) return;
    delete APP.forms[id];
    saveForms();
    if (id === APP.currentFormId) {
        var keys = Object.keys(APP.forms);
        if (keys.length > 0) loadForm(keys[0]);
        else newForm();
    }
    renderFormsList();
    toast('Eliminada');
}

function duplicateForm() {
    save();
    var curr = APP.forms[APP.currentFormId];
    if (!curr) return;
    var newId = 'f' + Date.now();
    var newF = JSON.parse(JSON.stringify(curr));
    newF.id = newId;
    newF.created = new Date().toISOString();
    newF.synced = false;
    if (newF.data) newF.data.nombre = (curr.data.nombre || '') + ' (c√≥pia)';
    APP.forms[newId] = newF;
    saveForms();
    loadForm(newId);
    toast('Duplicada!');
}

function updateBadge() {
    var form = APP.forms[APP.currentFormId];
    var name = 'Nova';
    if (form && form.data) {
        if (form.data.nombreEspacio) name = form.data.nombreEspacio;
        else if (form.data.nombre) name = form.data.nombre;
    }
    document.getElementById('currentFormBadge').textContent = name.substring(0, 12);
}

function renderFormsList() {
    var list = document.getElementById('formsList');
    var keys = Object.keys(APP.forms).sort(function(a, b) {
        return new Date(APP.forms[b].modified) - new Date(APP.forms[a].modified);
    });
    
    if (keys.length === 0) {
        list.innerHTML = '<p style="text-align:center;color:#888;">Sem fichas</p>';
        return;
    }
    
    list.innerHTML = keys.map(function(id) {
        var f = APP.forms[id];
        var name = (f.data && f.data.nombreEspacio) || (f.data && f.data.nombre) || 'Sem nome';
        var date = new Date(f.modified).toLocaleDateString('pt-PT');
        var active = id === APP.currentFormId ? 'active' : '';
        var syncClass = f.synced ? 'synced' : 'pending';
        var syncIcon = f.synced ? '‚úì' : '‚è≥';
        return '<div class="form-item ' + active + ' ' + syncClass + '" onclick="loadForm(\'' + id + '\'); closeModal(\'formsModal\');">' +
            '<div class="form-item-icon">üìã</div>' +
            '<div class="form-item-info"><div class="form-item-title">' + name + '</div><div class="form-item-meta">' + date + ' ' + syncIcon + '</div></div>' +
            '<div class="form-item-actions"><button class="form-item-btn delete" onclick="event.stopPropagation(); deleteForm(\'' + id + '\');">üóëÔ∏è</button></div>' +
            '</div>';
    }).join('');
}

// ===== SCALES & SELECTIONS =====
function selectScale(scaleId, val) {
    var form = APP.forms[APP.currentFormId];
    if (!form.scales) form.scales = {};
    form.scales[scaleId] = val;
    
    var container = document.getElementById('scale_' + scaleId);
    if (container) {
        container.querySelectorAll('.scale-btn').forEach(function(b) { b.classList.remove('selected'); });
        var btn = container.querySelector('[data-val="' + val + '"]');
        if (btn) btn.classList.add('selected');
    }
    save();
}

function selectRadio(item, name, val) {
    document.querySelectorAll('input[name="' + name + '"]').forEach(function(r) { r.parentElement.classList.remove('selected'); });
    item.classList.add('selected');
    item.querySelector('input').checked = true;
    save();
}

function selectQuad(q) {
    var form = APP.forms[APP.currentFormId];
    form.quadrant = q;
    document.querySelectorAll('.quadrant').forEach(function(el) { el.classList.remove('selected'); });
    var qMap = { 'alta-neg': 'qAltaNeg', 'alta-pos': 'qAltaPos', 'baja-neg': 'qBajaNeg', 'baja-pos': 'qBajaPos' };
    document.getElementById(qMap[q]).classList.add('selected');
    save();
}

function toggleSN(stim, type) {
    var form = APP.forms[APP.currentFormId];
    if (!form.stimuli) form.stimuli = {};
    
    document.getElementById(stim + 'S').classList.remove('selected');
    document.getElementById(stim + 'R').classList.remove('selected');
    document.getElementById(stim + type).classList.add('selected');
    form.stimuli[stim] = type;
    save();
}

// ===== NETWORK =====
function setupNetwork() {
    updateNetworkStatus();
    window.addEventListener('online', updateNetworkStatus);
    window.addEventListener('offline', updateNetworkStatus);
}

function updateNetworkStatus() {
    APP.isOnline = navigator.onLine;
    var badge = document.getElementById('networkBadge');
    if (APP.isOnline) {
        badge.textContent = 'üåê Online';
        badge.className = 'badge badge-online';
    } else {
        badge.textContent = 'üì¥ Offline';
        badge.className = 'badge badge-offline';
    }
    updateSyncStatus();
}

function updateSyncStatus() {
    var pending = Object.values(APP.forms).filter(function(f) { return !f.synced; }).length;
    var total = Object.keys(APP.forms).length;
    
    var bar = document.getElementById('syncBar');
    var info = document.getElementById('syncInfo');
    var statusBar = document.getElementById('statusBar');
    var pendingEl = document.getElementById('pendingCount');
    
    if (pending > 0) {
        bar.className = 'sync-bar pending';
        info.textContent = '‚è≥ ' + pending + ' ficha(s) por exportar';
        statusBar.className = 'status-bar has-pending';
        pendingEl.textContent = pending + '/' + total + ' pendentes';
    } else {
        bar.className = 'sync-bar';
        info.textContent = '‚úì Todas as fichas exportadas';
        statusBar.className = 'status-bar';
        pendingEl.textContent = total + ' fichas';
    }
}

// ===== EXPORT =====
function copyCurrentForSheets() {
    save();
    var f = APP.forms[APP.currentFormId];
    var text = generateSheetsData([f]);
    document.getElementById('currentCopyText').value = text;
    document.getElementById('currentCopyArea').classList.add('show');
    toast('Pronto! Toque ‚Üí Selecionar tudo ‚Üí Copiar');
}

function copyAllForSheets() {
    save();
    var forms = Object.values(APP.forms);
    var text = generateSheetsData(forms);
    document.getElementById('sheetsText').value = text;
    document.getElementById('sheetsArea').classList.add('show');
    toast('Pronto! Toque ‚Üí Selecionar tudo ‚Üí Copiar');
}

function generateSheetsData(forms) {
    var headers = ['ID','Nombre','Fecha','Espacio','Ubicacion','Actividad','atSelectiva','atSostenida','atOrientacion','atEjecutivo','atDividida','percSeguro','percOrdenado','percAcogedor','percClaro','emoValencia','emoActivacion','Cuadrante','Int1','Int2','Notas'];
    var rows = forms.map(function(f) {
        var d = f.data || {};
        var s = f.scales || {};
        return [
            f.id,
            d.nombre || '',
            d.fecha || '',
            d.nombreEspacio || '',
            d.ubicacion || '',
            d.actividad || '',
            s.atSelectiva !== undefined ? s.atSelectiva : '',
            s.atSostenida !== undefined ? s.atSostenida : '',
            s.atOrientacion !== undefined ? s.atOrientacion : '',
            s.atEjecutivo !== undefined ? s.atEjecutivo : '',
            s.atDividida !== undefined ? s.atDividida : '',
            s.percSeguro !== undefined ? s.percSeguro : '',
            s.percOrdenado !== undefined ? s.percOrdenado : '',
            s.percAcogedor !== undefined ? s.percAcogedor : '',
            s.percClaro !== undefined ? s.percClaro : '',
            s.emoValencia !== undefined ? s.emoValencia : '',
            s.emoActivacion !== undefined ? s.emoActivacion : '',
            f.quadrant || '',
            d.int1Cambio || '',
            d.int2Cambio || '',
            d.notasFinales || ''
        ].join('\t');
    });
    return headers.join('\t') + '\n' + rows.join('\n');
}

function exportAllJSON() {
    save();
    var data = { exported: new Date().toISOString(), forms: APP.forms };
    downloadFile(JSON.stringify(data, null, 2), 'fichas_backup_' + new Date().toISOString().split('T')[0] + '.json', 'application/json');
    // Mark as synced
    Object.keys(APP.forms).forEach(function(id) { APP.forms[id].synced = true; });
    saveForms();
    toast('Backup exportado!');
}

function exportCurrentJSON() {
    save();
    var f = APP.forms[APP.currentFormId];
    downloadFile(JSON.stringify(f, null, 2), 'ficha_' + (f.data.nombreEspacio || f.id) + '.json', 'application/json');
    f.synced = true;
    saveForms();
    toast('Exportado!');
}

function exportAllCSV() {
    save();
    var text = generateSheetsData(Object.values(APP.forms)).replace(/\t/g, ',');
    downloadFile(text, 'fichas_' + new Date().toISOString().split('T')[0] + '.csv', 'text/csv');
    Object.keys(APP.forms).forEach(function(id) { APP.forms[id].synced = true; });
    saveForms();
    toast('CSV exportado!');
}

function downloadFile(content, filename, type) {
    var blob = new Blob([content], { type: type + ';charset=utf-8' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function importBackup(input) {
    var file = input.files[0];
    if (!file) return;
    var reader = new FileReader();
    reader.onload = function(e) {
        try {
            var data = JSON.parse(e.target.result);
            if (data.forms) {
                Object.keys(data.forms).forEach(function(id) {
                    if (!APP.forms[id]) APP.forms[id] = data.forms[id];
                });
                saveForms();
                toast('Importado ' + Object.keys(data.forms).length + ' fichas!');
                renderFormsList();
            }
        } catch(err) {
            toast('Erro ao importar');
        }
    };
    reader.readAsText(file);
}

// ===== MODALS =====
function showModal(id) { document.getElementById(id).classList.add('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }
function showSyncModal() { showModal('syncModal'); }

function showHelp(key) {
    var h = HELP[key];
    if (!h) return;
    document.getElementById('helpTitle').textContent = h.title;
    document.getElementById('helpContent').innerHTML = h.text;
    showModal('helpModal');
}

// ===== TOAST =====
function toast(msg) {
    var t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(function() { t.classList.remove('show'); }, 3000);
}

// ===== START =====
init();
</script>

</body>
</html>
